@namespace Blatternfly.Components

@if (IsSearchMenuOpen)
{
  <div class="pf-c-search-input__menu">
    <div class="pf-c-search-input__menu-body">
      <Form Model="@Attributes">
        @foreach (var attr in Attributes)
        {
          @if (Array.IndexOf(Attributes, attr) == 0)
          {
            <FormGroup
              Label="@attr.Display"
              FieldId="@FormatFieldId(attr)"
              @key="attr"
            >
              <TextInput
                Type="TextInputTypes.Text"
                id="@FormatFieldId(attr)"
                Value="@GetValue(attr)"
                ValueExpression="@(() => attr.Attribute)"
                ValueChanged="@((string newValue) => HandleValueChange(attr, newValue))"
                @ref="FirstAttrRef"
              />
            </FormGroup>
          }
          else
          {
            <FormGroup
              Label="@attr.Display"
              FieldId="@FormatFieldId(attr)"
              @key="attr"
            >
              <TextInput
                Type="TextInputTypes.Text"
                id="@FormatFieldId(attr)"
                Value="@GetValue(attr)"
                ValueExpression="@(() => attr.Attribute)"
                ValueChanged="@((string newValue) => HandleValueChange(attr, newValue))"
              />
            </FormGroup>
          }
        }
        @FormAdditionalItems
        <ActionGroup>
          <Button Variant="ButtonVariant.Primary" Type="ButtonType.Submit" OnClick="@OnSearchHandler">
            @SubmitSearchButtonLabel
          </Button>
          @if (OnClear.HasDelegate)
          {
            <Button Variant="ButtonVariant.Link" Type="ButtonType.Reset" OnClick="@OnClear">
              @ResetButtonLabel
            </Button>
          }
        </ActionGroup>
      </Form>
    </div>
  </div>
}

@code {
  private TextInput FirstAttrRef { get; set; }

  /// Value of the search input.
  [Parameter] public string Value { get; set; }

  /// Function which builds an attribute-value map by parsing the value in the search input.
  [Parameter] public Func<IDictionary<string, string>> GetAttrValueMap { get; set; }

  /// A callback for when the search button clicked changes.
  [Parameter] public EventCallback<(string, IDictionary<string, string>)> OnSearch { get; set; }

  /// A callback for when the user clicks the clear button.
  [Parameter] public EventCallback<MouseEventArgs> OnClear { get; set; }

  /// A callback for when the input value changes.
  [Parameter] public EventCallback<ChangeEventArgs> OnChange { get; set; }

  /// Function called to toggle the advanced search menu.
  [Parameter] public EventCallback<MouseEventArgs> OnToggleAdvancedMenu { get; set; }

  /// Flag for toggling the open/close state of the advanced search menu.
  [Parameter] public bool IsSearchMenuOpen { get; set; }

  /// Label for the buttons which reset the advanced search form and clear the search input.
  [Parameter] public string ResetButtonLabel { get; set; } = "Reset";

  /// Label for the buttons which called the onSearch event handler.
  [Parameter] public string SubmitSearchButtonLabel { get; set; } = "Search";

  /// Array of attribute values used for dynamically generated advanced search.
  [Parameter] public SearchAttribute[] Attributes { get; set; } = Array.Empty<SearchAttribute>();

  /// Additional elements added after the attributes in the form.
  /// The new form elements can be wrapped in a FormGroup component for automatic formatting.
  [Parameter] public RenderFragment FormAdditionalItems { get; set; }

  /// Attribute label for strings unassociated with one of the provided listed attributes.
  [Parameter] public string HasWordsAttrLabel { get; set; } = "Has words";

  /// Delimiter in the query string for pairing attributes with search values.
  /// Required whenever attributes are passed as props.
  [Parameter] public string AdvancedSearchDelimiter { get; set; }

  private bool PutFocusBackOnInput { get; set; }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    await base.OnAfterRenderAsync(firstRender);

    if (firstRender)
    {
      if (IsSearchMenuOpen)
      {
        await FirstAttrRef.Element.FocusAsync();
        PutFocusBackOnInput = true;
      }
      else if (!IsSearchMenuOpen && PutFocusBackOnInput)
      {
        // TODO Give focus to parent component
      }
    }
  }

  // TODO Window Observer ??

  /*
  const onDocClick = (event: Event) => {
    const clickedWithinSearchInput = parentRef && parentRef.current.contains(event.target as Node);
    if (isSearchMenuOpen && !clickedWithinSearchInput) {
      onToggleAdvancedMenu(event as any);
    }
  };

  const onEscPress = (event: KeyboardEvent) => {
    const keyCode = event.keyCode || event.which;
    if (
      isSearchMenuOpen &&
      keyCode === KEY_CODES.ESCAPE_KEY &&
      parentRef &&
      parentRef.current.contains(event.target as Node)
    ) {
      onToggleAdvancedMenu(event as any);
      if (parentInputRef) {
        parentInputRef.current.focus();
      }
    }
  }
  */

  private string FormatFieldId(SearchAttribute attribute)
    => $"{attribute.Attribute}_{Array.IndexOf(Attributes, attribute)}";

  private string GetValue(SearchAttribute attribute)
  {
    var map = GetAttrValueMap();
    return map.ContainsKey(attribute.Attribute) ? map[attribute.Attribute] : string.Empty;
  }

  private async Task HandleValueChange(SearchAttribute attribute, string newValue)
  {
    var newMap = GetAttrValueMap();
    newMap[attribute.Attribute] = newValue;
    var updatedValue = string.Empty;

    foreach (var (key, value) in newMap)
    {
      if (!string.IsNullOrEmpty(value?.Trim()))
      {
        updatedValue = (key != "haswords")
          ? $"{updatedValue} {key}{AdvancedSearchDelimiter}{value}"
            : $"{updatedValue} {value}";
      }
    }

    updatedValue = System.Text.RegularExpressions.Regex.Replace(updatedValue, "\\s+", string.Empty);

    if (OnChange.HasDelegate)
    {
      await OnChange.InvokeAsync(new ChangeEventArgs { Value = updatedValue });
    }
  }

  private async Task OnSearchHandler(MouseEventArgs args)
  {
    // event.preventDefault();

    if (OnSearch.HasDelegate)
    {
      await OnSearch.InvokeAsync((Value, GetAttrValueMap()));
    }
    if (IsSearchMenuOpen)
    {
      await OnToggleAdvancedMenu.InvokeAsync(args);
    }
  }
}