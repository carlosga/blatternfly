@namespace Blatternfly.Components
@inherits BaseComponent
@inject IDomUtils DomUtils

<div @attributes="AdditionalAttributes" class="@CssClass">
  <div class="pf-c-toolbar__toggle">
    <Button
      Variant="ButtonVariant.Plain"
      OnClick="@ToggleIsExpanded"
      AriaLabel="Show Filters"
      aria-expanded="@AriaExpanded"
      aria-haspopup="@AriaHaspopup"
      aria-controls="@ExpandableContentId"
    >
      @ToggleIcon
    </Button>
  </div>
  @ChildContent
</div>

@code {
  [CascadingParameter] public Page ParentPage { get; set; }

  [CascadingParameter] public Toolbar Parent { get; set; }

  /// An icon to be rendered when the toggle group has collapsed down.
  [Parameter] public RenderFragment ToggleIcon { get; set; }

  /// Controls when filters are shown and when the toggle button is hidden.
  [Parameter] public Breakpoints? Breakpoint { get; set; }

  /// Visibility at various breakpoints.
  [Parameter] public Visibility Visibility { get; set; }

  /// A type modifier which modifies spacing specifically depending on the type of group.
  [Parameter] public ToolbarGroupVariant? Variant { get; set; }

  /// Alignment at various breakpoints..
  [Parameter] public Alignment Alignment { get; set; }

  /// Spacers at various breakpoints..
  [Parameter] public ToolbarSpacer ToolbarSpacer { get; set; }

  /// Space items at various breakpoints..
  [Parameter] public ToolbarSpaceItem ToolbarSpaceItems { get; set; }

  [Parameter] public EventCallback<MouseEventArgs> ToggleIsExpanded { get; set; }

  private string CssClass => new CssBuilder("pf-c-toolbar__group pf-m-toggle-group")
    .AddClass("pf-m-filter-group"     , Variant == ToolbarGroupVariant.FilterGroup)
    .AddClass("pf-m-icon-button-group", Variant == ToolbarGroupVariant.IconButtonGroup)
    .AddClass("pf-m-button-group"     , Variant == ToolbarGroupVariant.ButtonGroup)
    .AddClass(() => BreakpointMods.FromBreakpoint(Breakpoint.Value).CssClass(ParentPage?.Breakpoint), Breakpoint.HasValue)
    .AddClass(Visibility?.CssClass(ParentPage?.Breakpoint))
    .AddClass(Alignment?.CssClass(ParentPage?.Breakpoint))
    .AddClass(ToolbarSpacer?.CssClass(ParentPage?.Breakpoint))
    .AddClass(ToolbarSpaceItems?.CssClass(ParentPage?.Breakpoint))
    .AddClassFromAttributes(AdditionalAttributes)
    .Build();

  private Size<int> _windowSize;
  private string    AriaExpanded        { get => Parent.IsExpanded ? "true" : null; }
  private string    AriaHaspopup        { get => Parent.IsExpanded ? IsContentPopup() : null; }
  private string    ExpandableContentId { get => ""; }

  private string IsContentPopup()
  {
    return _windowSize.Width < GlobalBreakpoints.Large ? "true" : null;
  }

  protected override async Task OnParametersSetAsync()
  {
    await base.OnParametersSetAsync();

    if (!Breakpoint.HasValue || ToggleIcon is null)
    {
      throw new Exception("ToolbarToggleGroup will not be visible without a breakpoint or toggleIcon.");
    }

    _windowSize = await DomUtils.GetWindowSizeAsync();
  }
}